<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>My Time</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#43cea2,#185a9d);
  padding: 20px;
}
.card {
  max-width: 900px;
  margin: auto;
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  margin-bottom: 20px;
}
h2, h3 { text-align:center; }
input, select, button, textarea {
  padding: 8px;
  font-size: 14px;
  margin-top: 6px;
}
button {
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
.btn {
  background: #185a9d;
  color: #fff;
  width: 100%;
  padding: 10px;
  margin-top: 10px;
}
.btn-secondary {
  background: #6c757d;
  color: #fff;
  width: 100%;
  padding: 8px;
  margin-top: 6px;
}
.btn-green {
  background: #2ecc71;
  color: #fff;
  padding: 6px 10px;
  margin-left: 6px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #ddd;
  padding: 6px;
}
th { background:#f0f0f0; }
textarea { width:100%; min-height:40px; }
.hidden { display:none; }
.done { background:#d4edda; text-decoration: line-through; }
.row { display:flex; gap:10px; flex-wrap:wrap; }
.row > div { flex:1; }

/* NEW UI */
.slider {
  display:flex;
  justify-content:space-between;
  margin-top:10px;
}
.week {
  display:flex;
  justify-content:space-between;
  margin-top:10px;
}
.week div {
  flex:1;
  text-align:center;
  padding:6px;
  cursor:pointer;
  border-radius:6px;
}
.week .active {
  background:#185a9d;
  color:white;
}
</style>
</head>

<body>

<div id="loginBox" class="card">
  <h2>My Time</h2>
  <input id="passwordInput" type="password" placeholder="Enter password">
  <button class="btn" id="loginBtn">Login</button>
</div>

<div id="dashboard" class="card hidden">
  <h3>Dashboard</h3>
  <button class="btn" onclick="openTimetable()">Timetable</button>
</div>

<div id="timetableScreen" class="card hidden">
  <h3>Daily Timetable</h3>

  <!-- CALENDAR (UNCHANGED) -->
  <label>Date</label>
  <input type="date" id="ttDate">

  <!-- SLIDER -->
  <div class="slider">
    <button class="btn-secondary" onclick="shiftDate(-1)">◀ Previous</button>
    <button class="btn-secondary" onclick="shiftDate(1)">Next ▶</button>
  </div>

  <!-- WEEK STRIP -->
  <div class="week" id="weekStrip"></div>

  <div class="row">
    <div>
      <label>Start</label>
      <input type="time" id="startTime">
    </div>
    <div>
      <label>End</label>
      <input type="time" id="endTime">
    </div>
    <div>
      <label>Gap</label>
      <select id="gapSelect">
        <option value="30">30 min</option>
        <option value="60">1 hour</option>
        <option value="120">2 hours</option>
      </select>
    </div>
  </div>

  <button class="btn" onclick="buildAndLoad()">Build Timetable</button>
  <button class="btn-secondary" onclick="copyDay(-1)">Copy Yesterday</button>

  <table id="ttTable">
    <thead>
      <tr>
        <th style="width:220px;">Time Range</th>
        <th>Mission</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="btn" onclick="saveTimetable()">Save Timetable</button>
  <button class="btn" onclick="back()">Back</button>
</div>

<script>
const API = "https://my-time-backend.onrender.com";

/* LOGIN */
loginBtn.onclick = async () => {
  const r = await fetch(API+"/login",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ password: passwordInput.value })
  });
  if(!r.ok) return alert("Wrong password");
  loginBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
};

function back(){
  timetableScreen.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

function openTimetable(){
  dashboard.classList.add("hidden");
  timetableScreen.classList.remove("hidden");

  ttDate.value = new Date().toISOString().split("T")[0];
  startTime.value = localStorage.startTime || "05:00";
  endTime.value = localStorage.endTime || "23:59";
  gapSelect.value = localStorage.gap || "60";

  syncWeekStrip();
  buildAndLoad();
}

ttDate.onchange = () => {
  syncWeekStrip();
  buildAndLoad();
};

startTime.onchange = endTime.onchange = gapSelect.onchange = () => {
  localStorage.startTime = startTime.value;
  localStorage.endTime = endTime.value;
  localStorage.gap = gapSelect.value;
};

/* DATE HELPERS */
function shiftDate(diff){
  const d = new Date(ttDate.value);
  d.setDate(d.getDate()+diff);
  ttDate.value = d.toISOString().split("T")[0];
  syncWeekStrip();
  buildAndLoad();
}

function syncWeekStrip(){
  const base = new Date(ttDate.value);
  const day = base.getDay();
  const diff = day===0 ? -6 : 1-day;
  const monday = new Date(base);
  monday.setDate(base.getDate()+diff);

  const names=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  weekStrip.innerHTML="";

  for(let i=0;i<7;i++){
    const d = new Date(monday);
    d.setDate(monday.getDate()+i);
    const iso = d.toISOString().split("T")[0];

    const div = document.createElement("div");
    div.textContent = names[i];
    if(iso===ttDate.value) div.classList.add("active");

    div.onclick = () => {
      ttDate.value = iso;
      syncWeekStrip();
      buildAndLoad();
    };
    weekStrip.appendChild(div);
  }
}

/* TIMETABLE LOGIC (UNCHANGED) */
function toMin(t){ const [h,m]=t.split(":").map(Number); return h*60+m; }
function fmt(m){
  let h=Math.floor(m/60), mm=m%60;
  let ap=h>=12?"PM":"AM"; h=h%12||12;
  return `${h}:${String(mm).padStart(2,"0")} ${ap}`;
}

async function buildAndLoad(){
  const s = toMin(startTime.value);
  const e = toMin(endTime.value);
  const g = parseInt(gapSelect.value);

  const tbody = ttTable.querySelector("tbody");
  tbody.innerHTML = "";

  for(let cur=s; cur<e; cur+=g){
    let nxt=Math.min(cur+g,e);
    let key = `${cur}-${nxt}`;

    tbody.innerHTML += `
      <tr>
        <td>${fmt(cur)} – ${fmt(nxt)}</td>
        <td>
          <textarea data-key="${key}"></textarea>
          <button class="btn-green" onclick="this.parentElement.classList.toggle('done')">✔</button>
        </td>
      </tr>`;
  }

  const r = await fetch(API+"/timetable?date="+ttDate.value);
  const data = await r.json();

  document.querySelectorAll("textarea").forEach(t=>{
    const f = data.find(b=>b.hour === t.dataset.key);
    if(f){
      t.value = f.text;
      if(f.completed) t.parentElement.classList.add("done");
    }
  });
}

async function saveTimetable(){
  const blocks = [];
  document.querySelectorAll("textarea").forEach(t=>{
    blocks.push({
      hour: t.dataset.key,
      text: t.value,
      completed: t.parentElement.classList.contains("done")
    });
  });

  await fetch(API+"/timetable",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ date: ttDate.value, blocks })
  });

  alert("Saved");
}

async function copyDay(offset){
  const d = new Date(ttDate.value);
  d.setDate(d.getDate()+offset);
  const src = d.toISOString().split("T")[0];

  const r = await fetch(API+"/timetable?date="+src);
  const data = await r.json();

  document.querySelectorAll("textarea").forEach(t=>{
    const f = data.find(b=>b.hour === t.dataset.key);
    t.value = f ? f.text : "";
    t.parentElement.classList.toggle("done", f?.completed);
  });
}
</script>

</body>
</html>
