<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Time | Flow State</title>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6366f1">
<link rel="apple-touch-icon" href="icon-192.png">


    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #eef2ff;
            --accent: #10b981;
            --bg: #f8fafc;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text-main);
            padding: 20px 12px;
            line-height: 1.5;
        }

        .container {
            max-width: 900px;
            margin: auto;
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
        }

        h2 { font-weight: 800; letter-spacing: -0.5px; margin: 0; font-size: 2rem; }

        .card {
            background: var(--card);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 24px;
        }

        .date-input {
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-main);
            outline: none;
        }

        .nav-btn {
            background: var(--primary-light);
            color: var(--primary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover { background: var(--primary); color: white; }

        .week {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .week-day {
            flex: 1;
            min-width: 60px;
            padding: 12px 8px;
            text-align: center;
            border-radius: 14px;
            background: #f1f5f9;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .week-day.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 24px;
        }

        .btn {
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--primary-light); color: var(--primary); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
        
        .btn:hover { transform: translateY(-1px); filter: brightness(0.95); }

        .block {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 20px;
            border-radius: 20px;
            background: #fff;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            position: relative;
        }

        .block:hover { border-color: var(--primary); }
        .block.done { opacity: 0.6; background: #f8fafc; }
        .block.done textarea { text-decoration: line-through; color: var(--text-muted); }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-box {
            width: 90px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-weight: 700;
            text-align: center;
            font-size: 14px;
        }

        .block textarea {
            width: 100%;
            border: none;
            padding: 8px 0;
            font-size: 16px;
            resize: none;
            background: transparent;
            outline: none;
            color: var(--text-main);
            font-family: inherit;
        }

        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .btn-check { background: #dcfce7; color: #166534; }
        .btn-del { background: #fee2e2; color: #991b1b; }

        @media(min-width: 600px) {
            .block {
                grid-template-columns: auto 1fr auto;
                align-items: center;
            }
            .time-inputs { flex-direction: column; }
        }

        footer {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header-section">
        <h2>My Time</h2>
    </div>

    <div class="card">
        <div class="topbar">
            <button class="nav-btn" onclick="changeDay(-1)">‹</button>
            <input type="date" id="date" class="date-input">
            <button class="nav-btn" onclick="changeDay(1)">›</button>
        </div>

        <div class="week" id="week"></div>

        <div class="controls">
            <button class="btn btn-primary" onclick="addRow()">+ Add Task</button>
            <button class="btn btn-secondary" onclick="generate()">Quick Fill Day</button>
            <button class="btn btn-ghost" onclick="copyYesterday()">Copy Yesterday</button>
        </div>

        <div id="blocks"></div>

        <footer>
            <button class="btn btn-ghost" onclick="backup()">Backup Data</button>
            <button class="btn btn-ghost" onclick="restore()">Restore</button>
            <input type="file" id="file" hidden>
        </footer>
    </div>
</div>

<script>
    const dateEl = document.getElementById("date");
    const blocksEl = document.getElementById("blocks");
    dateEl.value = new Date().toISOString().split("T")[0];
    const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

    function store(d) { localStorage.setItem("myTimeModern", JSON.stringify(d)); }
    function loadStore() { return JSON.parse(localStorage.getItem("myTimeModern") || "{}"); }

    function parseTimeInput(input) {
        if (!input) return "09:00";
        let clean = input.toLowerCase().replace(/\s/g, '');
        let hours, minutes = 0;
        const ampm = clean.match(/[ap]m/);
        clean = clean.replace(/[ap]m/, '');
        if (clean.includes(':')) {
            [hours, minutes] = clean.split(':').map(Number);
        } else {
            hours = parseInt(clean);
        }
        if (ampm && ampm[0] === 'pm' && hours < 12) hours += 12;
        if (ampm && ampm[0] === 'am' && hours === 12) hours = 0;
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    function toPrettyTime(t) {
        let [h, m] = t.split(":").map(Number);
        const a = h >= 12 ? "PM" : "AM";
        h = h % 12 || 12;
        return `${h}:${m.toString().padStart(2, "0")} ${a}`;
    }

    function render() {
        blocksEl.innerHTML = "";
        buildWeek();
        const all = loadStore();
        let day = all[dateEl.value] || [];
        day.sort((a, b) => a.start.localeCompare(b.start));
        day.forEach((b, i) => {
            const div = document.createElement("div");
            div.className = "block" + (b.done ? " done" : "");
            div.innerHTML = `
                <div class="time-inputs">
                    <input type="text" class="time-box" value="${toPrettyTime(b.start)}" 
                           onblur="updateTime(${i}, 'start', this.value)" placeholder="Start">
                    <span style="color:var(--text-muted); font-size:12px">to</span>
                    <input type="text" class="time-box" value="${toPrettyTime(b.end)}" 
                           onblur="updateTime(${i}, 'end', this.value)" placeholder="End">
                </div>
                <textarea onchange="edit(${i},'text',this.value)" placeholder="What are we doing?">${b.text}</textarea>
                <div class="actions">
                    <button class="action-btn btn-check" onclick="toggle(${i})">✓</button>
                    <button class="action-btn btn-del" onclick="removeRow(${i})">✕</button>
                </div>
            `;
            blocksEl.appendChild(div);
        });
    }

    function updateTime(index, key, value) {
        const all = loadStore();
        all[dateEl.value][index][key] = parseTimeInput(value);
        store(all);
        render();
    }

    function buildWeek() {
        const w = document.getElementById("week");
        w.innerHTML = "";
        const base = new Date(dateEl.value);
        for (let i = 0; i < 7; i++) {
            const d = new Date(base);
            d.setDate(base.getDate() - base.getDay() + i);
            const dateStr = d.toISOString().slice(0, 10);
            const div = document.createElement("div");
            div.className = `week-day ${dateStr === dateEl.value ? 'active' : ''}`;
            div.innerHTML = `<div>${days[i]}</div><div style="font-size:10px">${d.getDate()}</div>`;
            div.onclick = () => { dateEl.value = dateStr; render(); };
            w.appendChild(div);
        }
    }

    function changeDay(n) {
        const d = new Date(dateEl.value);
        d.setDate(d.getDate() + n);
        dateEl.value = d.toISOString().slice(0, 10);
        render();
    }

    function addRow() {
        const all = loadStore();
        all[dateEl.value] = all[dateEl.value] || [];
        all[dateEl.value].push({ start: "09:00", end: "10:00", text: "", done: false });
        store(all);
        render();
    }

    function generate() {
        const all = loadStore();
        const rows = [];
        for (let h = 8; h < 20; h += 2) {
            rows.push({
                start: h.toString().padStart(2, "0") + ":00",
                end: (h + 2).toString().padStart(2, "0") + ":00",
                text: "",
                done: false
            });
        }
        all[dateEl.value] = rows;
        store(all); render();
    }

    function copyYesterday() {
        const all = loadStore();
        const d = new Date(dateEl.value);
        d.setDate(d.getDate() - 1);
        const y = d.toISOString().slice(0, 10);
        if (!all[y]) return alert("No data found for yesterday.");
        all[dateEl.value] = JSON.parse(JSON.stringify(all[y]));
        store(all); render();
    }

    function edit(i, k, v) {
        const all = loadStore();
        all[dateEl.value][i][k] = v;
        store(all);
    }

    function toggle(i) {
        const all = loadStore();
        all[dateEl.value][i].done = !all[dateEl.value][i].done;
        store(all); render();
    }

    function removeRow(i) {
        const all = loadStore();
        all[dateEl.value].splice(i, 1);
        store(all); render();
    }

    function backup() {
        const d = localStorage.getItem("myTimeModern");
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([d]));
        a.download = `backup-${dateEl.value}.json`;
        a.click();
    }

    function restore() { document.getElementById("file").click(); }
    document.getElementById("file").onchange = e => {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = () => { store(JSON.parse(r.result)); render(); };
        r.readAsText(f);
    };

    dateEl.onchange = render;
    render();

    // --- PWA SERVICE WORKER REGISTRATION ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker registered!'))
                .catch(err => console.log('Service Worker failed: ', err));
        });
    }
</script>

</body>
</html>
