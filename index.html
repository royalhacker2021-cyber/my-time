<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>My Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body style="font-family:Arial;background:#f6f7f9;padding:20px;">

<!-- LOGIN -->
<div id="loginBox" style="max-width:400px;margin:auto;background:#fff;padding:20px;border-radius:8px;">
  <h2>My Time</h2>
  <input id="password" type="password" placeholder="Enter password" style="width:100%;padding:10px;">
  <button id="loginBtn" style="width:100%;padding:10px;margin-top:10px;">Login</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" style="display:none;max-width:400px;margin:auto;background:#fff;padding:20px;border-radius:8px;">
  <h3>Dashboard</h3>
  <button onclick="openTasks()" style="width:100%;padding:10px;">Tasks</button>
  <button onclick="openTimetable()" style="width:100%;padding:10px;margin-top:8px;">Timetable</button>
</div>

<!-- TASKS -->
<div id="tasksScreen" style="display:none;max-width:400px;margin:auto;background:#fff;padding:20px;border-radius:8px;">
  <h3>Tasks</h3>

  <input type="date" id="taskDate" style="width:100%;padding:8px;">
  <input id="taskInput" placeholder="New task" style="width:100%;padding:10px;margin-top:8px;">
  <button onclick="addTask()" style="width:100%;padding:10px;margin-top:8px;">Add Task</button>

  <ul id="taskList" style="padding:0;margin-top:10px;"></ul>

  <button onclick="backToDashboard()" style="width:100%;padding:10px;margin-top:10px;">Back</button>
</div>

<!-- TIMETABLE -->
<div id="timetableScreen" style="display:none;max-width:400px;margin:auto;background:#fff;padding:20px;border-radius:8px;">
  <h3>Timetable</h3>

  <!-- DATE FOR TIMETABLE -->
  <input type="date" id="timetableDate" style="width:100%;padding:8px;margin-bottom:10px;">

  <div id="timeBlocks"></div>

  <button onclick="saveTimetable()" style="width:100%;padding:10px;margin-top:10px;">
    Save Timetable
  </button>

  <button onclick="backToDashboardFromTimetable()" style="width:100%;padding:10px;margin-top:10px;">
    Back
  </button>
</div>

<script>
const API = "https://my-time-backend.onrender.com";

/* LOGIN */
document.getElementById("loginBtn").addEventListener("click", login);

function login() {
  fetch(API + "/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: password.value })
  })
  .then(res => {
    if (!res.ok) throw new Error("Wrong password");
    return res.json();
  })
  .then(() => {
    loginBox.style.display = "none";
    dashboard.style.display = "block";
  })
  .catch(err => alert(err.message));
}

/* NAVIGATION */
function openTasks() {
  dashboard.style.display = "none";
  tasksScreen.style.display = "block";
  taskDate.valueAsDate = new Date();
  loadTasks();
}

function backToDashboard() {
  tasksScreen.style.display = "none";
  dashboard.style.display = "block";
}

function openTimetable() {
  dashboard.style.display = "none";
  timetableScreen.style.display = "block";
  timetableDate.valueAsDate = new Date();
  loadTimetable();
}

function backToDashboardFromTimetable() {
  timetableScreen.style.display = "none";
  dashboard.style.display = "block";
}

/* TASKS */
function loadTasks() {
  fetch(API + "/tasks?date=" + taskDate.value)
    .then(r => r.json())
    .then(data => {
      taskList.innerHTML = "";
      data.forEach(t => {
        let li = document.createElement("li");
        li.style.listStyle = "none";
        li.style.padding = "6px";
        li.innerHTML = `${t.text}
          <button onclick="completeTask('${t._id}')">âœ”</button>`;
        taskList.appendChild(li);
      });
    });
}

taskDate.onchange = loadTasks;

function addTask() {
  fetch(API + "/tasks", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      text: taskInput.value,
      date: taskDate.value
    })
  }).then(() => {
    taskInput.value = "";
    loadTasks();
  });
}

function completeTask(id) {
  fetch(API + "/tasks/" + id, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ completed: true })
  }).then(loadTasks);
}

/* TIMETABLE */
timetableDate.onchange = loadTimetable;

function loadTimetable() {
  fetch(API + "/timetable?date=" + timetableDate.value)
    .then(r => r.json())
    .then(data => {
      timeBlocks.innerHTML = "";
      for (let i = 6; i <= 22; i++) {
        let hour = i + ":00";
        let saved = data.find(b => b.hour === hour);
        let div = document.createElement("div");
        div.innerHTML = `
          <strong>${hour}</strong>
          <input data-hour="${hour}"
            value="${saved ? saved.text : ""}"
            style="width:100%;padding:6px;margin-bottom:6px;">
        `;
        timeBlocks.appendChild(div);
      }
    });
}

function saveTimetable() {
  let blocks = [];
  document.querySelectorAll("#timeBlocks input").forEach(inp => {
    blocks.push({
      hour: inp.dataset.hour,
      text: inp.value,
      date: timetableDate.value
    });
  });

  fetch(API + "/timetable", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      date: timetableDate.value,
      blocks
    })
  }).then(() => alert("Timetable saved"));
}
</script>

</body>
</html>
